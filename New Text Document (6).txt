name: 4. Apigee/ Promote
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Promotion sequence
        required: true
        options:
          - from DEV to TEST
          - from TEST to PREPROD
          - from PREPROD to PROD
      externalization:
        type: boolean
        description: Is external environment
        required: false
        default: false
      changeTicket:
        type: string
        required: false
        default: ''
env:
  github_token: ${{ secrets.GIT_HUB_TOKEN }}
  provisioning_token: ${{ secrets.PROVISIONING_TOKEN }}
jobs:
  apigee-promotion:
    name: Apigee Promotion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Set Github Environment
        uses: ./.github/workflows/actions/setvars
      - name: Checkout Provisioning CLI
        uses: ./.github/workflows/actions/checkout-provisioningcli
      - name: Apigee Promotion
        uses: ./.github/actions/Actions-Provisioning@v2
        env:
          inputEnvironment: ${{ github.event.inputs.environment }}
          inputExternalization: ${{ github.event.inputs.externalization }}
          inputChangeTicket: ${{ github.event.inputs.changeTicket }}
        with:
          provisioning_token: ${{ secrets.PROVISIONING_TOKEN }}
          client_id: ${{ secrets.OAUTH2_CLIENT_ID }}
          client_secret: ${{ secrets.OAUTH2_CLIENT_SECRET }}
          provisioning_cli_version: 'latest'
          script: .github/workflows/scripts/apigee_promotion.sh